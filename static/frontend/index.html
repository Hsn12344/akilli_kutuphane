<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Akıllı Kütüphane Yönetim Sistemi</title>
<style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0;}
    header { background:#007BFF; color:white; padding:1rem; text-align:center;}
    nav { background:#0056b3; padding:0.5rem; display:flex; justify-content:center; gap:1rem;}
    nav button { padding:0.5rem 1rem; color:white; border:none; cursor:pointer; background:#007BFF;}
    nav button:hover { background:#0056b3;}
    main { padding:1rem;}
    section { display:none; background:white; padding:1rem; margin:1rem auto; max-width:900px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    input, select { padding:0.5rem; margin:0.5rem 0; width:100%;}
    table { width:100%; border-collapse:collapse; margin-top:1rem;}
    table, th, td { border:1px solid #ccc;}
    th, td { padding:0.5rem; text-align:left;}
    button.action-btn { padding:0.3rem 0.5rem; margin:0 0.2rem; cursor:pointer;}
    .hidden { display:none;}
</style>
</head>
<body>

<header>
<h1>Akıllı Kütüphane Yönetim Sistemi</h1>
</header>

<nav>
    <button onclick="showSection('loginSection')">Giriş</button>
    <button onclick="showSection('registerSection')">Kayıt Ol</button>
    <button onclick="showSection('booksSection')">Kitaplar</button>
    <button onclick="showSection('borrowedSection')">Ödünçlerim</button>
    <button onclick="showSection('adminSection')">Admin</button>
    <button onclick="logout()">Çıkış Yap</button>
</nav>

<main>
    <!-- Login -->
    <section id="loginSection">
        <h2>Giriş Yap</h2>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Şifre">
        <button onclick="login()">Giriş</button>
        <p id="loginMessage"></p>
    </section>

    <!-- Register -->
    <section id="registerSection">
        <h2>Kayıt Ol</h2>
        <input type="text" id="registerName" placeholder="İsim">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Şifre">
        <button onclick="register()">Kayıt Ol</button>
        <p id="registerMessage"></p>
    </section>

    <!-- Books -->
    <section id="booksSection">
        <h2>Kitap Listesi</h2>
        <input type="text" id="bookSearch" placeholder="Kitap ara..." oninput="fetchBooks(this.value)">
        <table id="booksTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Başlık</th>
                    <th>Yazar</th>
                    <th>Kategori</th>
                    <th>Mevcut</th>
                    <th>İşlem</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="booksMessage"></p>
    </section>

    <!-- Borrowed Books -->
    <section id="borrowedSection">
        <h2>Ödünç Aldığım Kitaplar</h2>
        <table id="borrowedTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Kitap</th>
                    <th>Alış Tarihi</th>
                    <th>Teslim Tarihi</th>
                    <th>İade Tarihi</th>
                    <th>İşlem</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- Admin Section -->
    <section id="adminSection">
        <h2>Admin Paneli</h2>

        <h3>Kitap İşlemleri</h3>
        <input type="text" id="adminBookTitle" placeholder="Başlık">
        <input type="text" id="adminBookISBN" placeholder="ISBN">
        <input type="text" id="adminBookAuthor" placeholder="Yazar">
        <input type="number" id="adminBookCategory" placeholder="Kategori ID">
        <input type="number" id="adminBookCopies" placeholder="Mevcut Adet" value="1">
        <button onclick="addBook()">Kitap Ekle</button>
        <p id="adminBookMessage"></p>

        <h3>Kategori İşlemleri</h3>
        <input type="text" id="adminCategoryName" placeholder="Kategori Adı">
        <button onclick="addCategory()">Kategori Ekle</button>
        <table id="categoryTable">
            <thead>
                <tr><th>ID</th><th>Adı</th><th>İşlem</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Kullanıcı İşlemleri</h3>
        <input type="email" id="adminMakeEmail" placeholder="Kullanıcı Email">
        <button onclick="makeAdmin()">Admin Yap</button>
        <p id="adminMakeMessage"></p>

        <h3>Ödünç Kitaplar</h3>
        <table id="adminBorrowedTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Kitap</th>
                    <th>Kullanıcı</th>
                    <th>Alış Tarihi</th>
                    <th>Teslim Tarihi</th>
                    <th>İade Tarihi</th>
                    <th>İşlem</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>
</main>

<script>
const API_URL = "http://127.0.0.1:5000";
let token = null;
let userRole = null;
let userEmail = null;

// Sayfa açıldığında otomatik yönlendirme
window.addEventListener('DOMContentLoaded', () => {
    token = localStorage.getItem('token');
    userRole = localStorage.getItem('role');
    userEmail = localStorage.getItem('email');

    if(token) {
        if(userRole === 'admin') showSection('adminSection');
        else showSection('booksSection');
    } else {
        showSection('loginSection');
    }
});

function showSection(sectionId){
    document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';
    if(sectionId==='booksSection') fetchBooks();
    if(sectionId==='borrowedSection') fetchBorrowed();
    if(sectionId==='adminSection') {
        fetchCategories();
        fetchBooks();
        fetchAllBorrowed();
    }
}

// Login
async function login(){
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const res = await fetch(`${API_URL}/auth/login`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email,password})
    });
    const data = await res.json();
    document.getElementById("loginMessage").textContent = data.message || data.error;
    if(res.ok){
        token = data.access_token;
        userRole = data.role;
        userEmail = email;

        // LocalStorage’a kaydet
        localStorage.setItem('token', token);
        localStorage.setItem('role', userRole);
        localStorage.setItem('email', userEmail);

        alert("Giriş başarılı!");
        if(userRole === 'admin') showSection('adminSection');
        else showSection('booksSection');
    }
}

// Logout
function logout(){
    token = null;
    userRole = null;
    userEmail = null;
    localStorage.clear();
    showSection('loginSection');
}

// Register
async function register(){
    const name=document.getElementById("registerName").value;
    const email=document.getElementById("registerEmail").value;
    const password=document.getElementById("registerPassword").value;
    const res=await fetch(`${API_URL}/auth/register`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({name,email,password})
    });
    const data=await res.json();
    document.getElementById("registerMessage").textContent=data.message||data.error;
}

// Kitap listele
async function fetchBooks(search=""){
    let url = `${API_URL}/books`;
    if(search) url = `${API_URL}/books/search?title=${encodeURIComponent(search)}`;
    const res = await fetch(url);
    const books = await res.json();
    const tbody=document.querySelector("#booksTable tbody");
    tbody.innerHTML='';
    books.forEach(book=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${book.id}</td>
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.category}</td>
            <td>${book.available_copies}</td>
            <td>
                ${book.available_copies>0 ? `<button class="action-btn" onclick="borrowBook(${book.id})">Ödünç Al</button>` : 'Stokta Yok'}
                ${userRole==='admin' ? `<button class="action-btn" onclick="deleteBook(${book.id})">Sil</button>` : ''}
            </td>`;
        tbody.appendChild(tr);
    });
}

// Ödünç al
async function borrowBook(bookId){
    if(!token){ alert("Giriş yapın"); return; }
    const res=await fetch(`${API_URL}/borrow`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
        body:JSON.stringify({book_id:bookId})
    });
    const data=await res.json();
    alert(data.message || "Kitap ödünç alındı!");
    fetchBooks();
    fetchBorrowed();
}

// Ödünç listeleme
async function fetchBorrowed(){
    if(!token) return;
    const res=await fetch(`${API_URL}/borrow/borrows`,{
        headers:{'Authorization':`Bearer ${token}`}
    });
    const borrows=await res.json();
    const tbody=document.querySelector("#borrowedTable tbody");
    tbody.innerHTML='';
    borrows.forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
            <td>${b.id}</td>
            <td>${b.book}</td>
            <td>${b.borrow_date}</td>
            <td>${b.due_date}</td>
            <td>${b.return_date || '-'}</td>
            <td>${!b.return_date ? `<button class="action-btn" onclick="returnBook(${b.id})">İade Et</button>` : ''}</td>
        `;
        tbody.appendChild(tr);
    });
}

// İade et
async function returnBook(borrowId){
    if(!token){ alert("Giriş yapın"); return; }
    const res=await fetch(`${API_URL}/borrow/return/${borrowId}`,{
        method:'POST',
        headers:{'Authorization':`Bearer ${token}`}
    });
    const data=await res.json();
    alert(data.message || "İade işlemi tamamlandı!");
    fetchBooks();
    fetchBorrowed();
}

// Admin kitap işlemleri
async function addBook(){
    if(!token || userRole!=='admin'){ alert("Admin giriş yapın"); return; }
    const title=document.getElementById("adminBookTitle").value;
    const isbn=document.getElementById("adminBookISBN").value;
    const author_name=document.getElementById("adminBookAuthor").value;
    const category_id=parseInt(document.getElementById("adminBookCategory").value);
    const available_copies=parseInt(document.getElementById("adminBookCopies").value);
    const res=await fetch(`${API_URL}/books`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
        body:JSON.stringify({title,isbn,author_name,category_id,available_copies})
    });
    const data=await res.json();
    document.getElementById("adminBookMessage").textContent=data.message || "Kitap eklendi";
    fetchBooks();
}

// Admin kitap sil
async function deleteBook(bookId){
    if(!token || userRole!=='admin'){ alert("Admin giriş yapın"); return; }
    const res=await fetch(`${API_URL}/books/${bookId}`,{
        method:'DELETE',
        headers:{'Authorization':`Bearer ${token}`}
    });
    const data=await res.json();
    alert(data.message || data.error);
    fetchBooks();
}

// Admin kullanıcı işlemleri
async function makeAdmin(){
    if(!token || userRole!=='admin'){ alert("Admin giriş yapın"); return; }
    const email=document.getElementById("adminMakeEmail").value;
    const res=await fetch(`${API_URL}/make-admin`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
        body:JSON.stringify({email})
    });
    const data=await res.json();
    document.getElementById("adminMakeMessage").textContent=data.message || data.error;
}

// Kategori işlemleri
async function fetchCategories(){
    const res=await fetch(`${API_URL}/categories`);
    const categories=await res.json();
    const tbody=document.querySelector("#categoryTable tbody");
    tbody.innerHTML='';
    categories.forEach(cat=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${cat.id}</td><td>${cat.name}</td>
        <td><button class="action-btn" onclick="deleteCategory(${cat.id})">Sil</button></td>`;
        tbody.appendChild(tr);
    });
}

async function addCategory(){
    if(!token || userRole!=='admin'){ alert("Admin giriş yapın"); return; }
    const name=document.getElementById("adminCategoryName").value;
    const res=await fetch(`${API_URL}/categories`,{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
        body:JSON.stringify({name})
    });
    await res.json();
    fetchCategories();
}

async function deleteCategory(catId){
    if(!token || userRole!=='admin'){ alert("Admin giriş yapın"); return; }
    const res=await fetch(`${API_URL}/categories/${catId}`,{
        method:'DELETE',
        headers:{'Authorization':`Bearer ${token}`}
    });
    await res.json();
    fetchCategories();
    fetchBooks();
}

// Admin: tüm ödünçleri listeleme
async function fetchAllBorrowed(){
    if(!token || userRole!=='admin') return;
    const res = await fetch(`${API_URL}/borrow/borrows`, {
        headers:{'Authorization':`Bearer ${token}`}
    });
    const borrows = await res.json();
    const tbody = document.querySelector("#adminBorrowedTable tbody");
    tbody.innerHTML='';
    borrows.forEach(b=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b.id}</td>
            <td>${b.book}</td>
            <td>${b.user}</td>
            <td>${b.borrow_date}</td>
            <td>${b.due_date}</td>
            <td>${b.return_date || '-'}</td>
            <td>${!b.return_date ? `<button class="action-btn" onclick="returnBook(${b.id})">İade Et</button>` : ''}</td>
        `;
        tbody.appendChild(tr);
    });
}
</script>

</body>
</html>
